<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>My Web App Journey - Wep API Routing | My Perspective of the world</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="My Web App Journey - Wep API Routing" />
<meta name="author" content="Jonathan Tweedle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In the previous chapter I initialized the node project and configured it to use Typescript. I finished it off by creating a simple express application to respond to web requests." />
<meta property="og:description" content="In the previous chapter I initialized the node project and configured it to use Typescript. I finished it off by creating a simple express application to respond to web requests." />
<link rel="canonical" href="https://xiltch.github.io/2018/11/09/my-web-app-journey-wep-api-routing/" />
<meta property="og:url" content="https://xiltch.github.io/2018/11/09/my-web-app-journey-wep-api-routing/" />
<meta property="og:site_name" content="My Perspective of the world" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-09T10:17:44+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="My Web App Journey - Wep API Routing" />
<script type="application/ld+json">
{"description":"In the previous chapter I initialized the node project and configured it to use Typescript. I finished it off by creating a simple express application to respond to web requests.","headline":"My Web App Journey - Wep API Routing","url":"https://xiltch.github.io/2018/11/09/my-web-app-journey-wep-api-routing/","datePublished":"2018-11-09T10:17:44+00:00","dateModified":"2018-11-09T10:17:44+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiltch.github.io/2018/11/09/my-web-app-journey-wep-api-routing/"},"author":{"@type":"Person","name":"Jonathan Tweedle"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://xiltch.github.io/feed.xml" title="My Perspective of the world" /><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XPPPBC54MV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XPPPBC54MV');
</script></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">My Perspective of the world</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/links/">Links</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">My Web App Journey - Wep API Routing</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-11-09T10:17:44+00:00" itemprop="datePublished">Nov 9, 2018
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Jonathan Tweedle</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In the <a href="/2018/11/08/my-web-app-journey-beginnings-of-the-web-api/">previous chapter</a> I initialized the node project and configured it to use Typescript. I finished it off by creating a simple express application to respond to web requests.</p>

<p>In this project I will refactor the design and move things around a little and add some routing to handle more complicated design. Another goal is to migrate the design to something that is hopefully more scalable in its design for future iterations.</p>

<p>Now before I start, while you can use a browser to connect to the API it does not offer all the tools to design a Web API. I recommend the use of a software package like <a href="https://www.getpostman.com/">PostMan</a> which really helps when developing your different API calls.</p>

<h2 id="be-more-abstract">Be more abstract</h2>

<p>Taking some design from the angular method, they split the server implementation from the definition into two separate files. As we already have the integration file, we need to move the design pieces over into the “app.ts” file and leave the “server.ts” more lean so that I have this.</p>

<h4 id="serverts">server.ts</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">app</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./app</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">HOST</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="nx">HOST</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">listening on port </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">PORT</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>For this to work I need to make sure that in the app.ts file I create an instance of the express application and set it up so that in our server file we focus on telling the application to listen for new connections. I settled on the following to a more <a href="https://en.wikipedia.org/wiki/Object-oriented_programming">OOP</a> style approach and wrapping the express application in my own Class definition.</p>

<h4 id="appts">app.ts</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="p">{</span>

  <span class="k">public</span> <span class="nx">app</span><span class="p">:</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Application</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="nx">config</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">client connected</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello World</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>
      
  <span class="p">}</span>

<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">App</span><span class="p">().</span><span class="nx">app</span><span class="p">;</span>
</code></pre></div></div>

<p>At this point I am getting tired of running <code class="language-plaintext highlighter-rouge">npm start</code> every time I make a change to my code. Thankfully there is some nice tools to help with this problem. I am going to use <code class="language-plaintext highlighter-rouge">nodemon</code> and <code class="language-plaintext highlighter-rouge">ts-node</code> to monitor for changes in the src while I am developing and if there are changes, it will restart using the new ts files.</p>

<p>I already had nodemon installed in a previous step so all I needed was to add ts-node to my list of dev dependencies. The easiest way is with the following command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install ts-node --save-dev
</code></pre></div></div>

<p>Now I have to add a new script that I can use to call nodemon so I open the package.json file in the root directory and update the scripts to include my new script.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"dev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nodemon --config nodemon-dev.json"</span><span class="w">
</span></code></pre></div></div>

<p>As you might notice this relies on a configuration file called <code class="language-plaintext highlighter-rouge">nodemon-dev.json</code> which should be located in the root folder next to our <code class="language-plaintext highlighter-rouge">package.json</code> file with the following details.</p>

<h4 id="nodemon-devjson">nodemon-dev.json</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"watch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"src"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"ext"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ignore"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"src/**/*.spec.ts"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"exec"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ts-node ./src/server.ts"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And with that I can run <code class="language-plaintext highlighter-rouge">npm run dev</code> and it will restart the server as I update the code.</p>

<h2 id="becoming-more-controlling">Becoming more controlling</h2>

<p>So our API is coming along nicely however we are still a little heavy in a single point of the project, the app definition. As we expand the API to include new endpoints with different GET/POST requests, it will become very bloated.</p>

<p>I like the controller pattern from MVC C# solutions but also want something modular should I want to use the controllers in other projects.</p>

<p>So I add a new directory under the src folder called <code class="language-plaintext highlighter-rouge">controllers</code> that will host each of the controllers I want to build out.</p>

<p>I can now create a new controller to handle the root path of the web API and call it <code class="language-plaintext highlighter-rouge">root.ts</code>. Looking at the src directory I now have the following layout.</p>

<p><img src="/assets/2018/11/midas_201811082319.png" alt="midas_201811082319" /></p>

<p>To make the root controller work, it needs to create a router for the request similar to what I have currently in the <code class="language-plaintext highlighter-rouge">app.ts</code> file. I will later take use the resulting router to map it to the main application.</p>

<h4 id="rootts">root.ts</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">Router</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">router</span><span class="p">:</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Router</span><span class="p">();</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Got a new connection</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Welcome to the Midas API server</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">RootController</span><span class="p">:</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div></div>

<p>Next I need to wire the routes for my endpoints between the controllers and the main application. Once again, I want to keep the bloat out of the main app file so I created a separate file to handle the route mapping.</p>

<h4 id="routests">routes.ts</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">RootController</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./controllers/root</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">Mapper</span> <span class="p">{</span>

  <span class="k">public</span> <span class="nx">addRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nx">RootController</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">RouteMapper</span><span class="p">:</span> <span class="nx">Mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mapper</span><span class="p">();</span>
</code></pre></div></div>

<p>All that is needed now is to update the app definition to import my route mapper while removing the now irrelevant get call. So now this is what the app definition looks like.</p>

<h4 id="appts-1">app.ts</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouteMapper</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./routes</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nx">app</span><span class="p">:</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Application</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>
        <span class="nx">RouteMapper</span><span class="p">.</span><span class="nx">addRoutes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="nx">config</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">App</span><span class="p">().</span><span class="nx">app</span><span class="p">;</span>
</code></pre></div></div>

<p>I am now ready to scale out the different endpoints of my API by creating a controller for each endpoint and then mapping it to a given route. The one benefit of this design is when designing the controllers the paths are relative so if you want to change the route, you can do it by updating a single line.</p>

<p>In the <a href="/2018/12/04/my-web-app-journey-controllers/">next chapter</a> I will create dummy controller with various GET and POST handlers that will get mapped to a route. It will also return some dummy data in a json format.</p>


  </div><a class="u-url" href="/2018/11/09/my-web-app-journey-wep-api-routing/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">My Perspective of the world</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">My Perspective of the world</li><li><a class="u-email" href="mailto:xiltch@gmail.com">xiltch@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/xiltch"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">xiltch</span></a></li><li><a href="https://www.twitter.com/xiltch"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">xiltch</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>The chronicles of a geek, author of code and connoisseur of fine electronics.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
