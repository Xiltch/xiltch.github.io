<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>My Web App Journey - Mind the Gap | My Perspective of the world</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="My Web App Journey - Mind the Gap" />
<meta name="author" content="Jonathan Tweedle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Back in December I began my exploration of creating my own OpenFaaS micro server. Because of natural tendency towards torture, the process was a slight deviation from the normal making for a much more complicated deployment as compared to the simple guide from Alex." />
<meta property="og:description" content="Back in December I began my exploration of creating my own OpenFaaS micro server. Because of natural tendency towards torture, the process was a slight deviation from the normal making for a much more complicated deployment as compared to the simple guide from Alex." />
<link rel="canonical" href="https://xiltch.github.io/2021/02/07/my-web-app-journey-mind-the-gap/" />
<meta property="og:url" content="https://xiltch.github.io/2021/02/07/my-web-app-journey-mind-the-gap/" />
<meta property="og:site_name" content="My Perspective of the world" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-07T11:17:43+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="My Web App Journey - Mind the Gap" />
<script type="application/ld+json">
{"description":"Back in December I began my exploration of creating my own OpenFaaS micro server. Because of natural tendency towards torture, the process was a slight deviation from the normal making for a much more complicated deployment as compared to the simple guide from Alex.","headline":"My Web App Journey - Mind the Gap","url":"https://xiltch.github.io/2021/02/07/my-web-app-journey-mind-the-gap/","datePublished":"2021-02-07T11:17:43+00:00","dateModified":"2021-02-07T11:17:43+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiltch.github.io/2021/02/07/my-web-app-journey-mind-the-gap/"},"author":{"@type":"Person","name":"Jonathan Tweedle"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://xiltch.github.io/feed.xml" title="My Perspective of the world" /><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XPPPBC54MV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XPPPBC54MV');
</script></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">My Perspective of the world</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/links/">Links</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">My Web App Journey - Mind the Gap</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-02-07T11:17:43+00:00" itemprop="datePublished">Feb 7, 2021
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Jonathan Tweedle</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Back in December <a href="/2020/12/06/my-web-app-journey-openfaas/">I began my exploration</a> of creating my own OpenFaaS micro server. Because of natural tendency towards torture, the process was a slight deviation from the normal making for a much more complicated deployment as compared to the <a href="https://alexellisuk.medium.com/walk-through-install-kubernetes-to-your-raspberry-pi-in-15-minutes-84a8492dc95a">simple guide from Alex</a>.</p>

<p>For some reason I focused on a setup that does not deploy the compiled images to the public github registry or using letEncrypt to act as my Certificate Authority. That decision turned into a snowball of challenges that I needed to find solutions for.</p>

<h3 id="the-circle-of-trust">The Circle of Trust</h3>

<p>The linchpin that ensures everything will work together is my own Certificate Authority. The first step is generating your own certificates used for signing certificates which each of the layers will ultimately trust because your personal CA signed them as being trusted them and as long as each of your services trust the CA … anything using a certificate signed by your CA will therefore also be trusted.</p>

<blockquote>
  <p>Generate your own CA</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa -des3 -out homeCA.key 2048
openssl req -x509 -new -nodes -key homeCA.key -sha256 -days 1825 -out homeCA.pem
</code></pre></div></div>

<p>You will need to answer a few questions, such as a pass phrase for the key but also some additional details but with it being a private CA … such details wont really serve much purpose.</p>

<p>With your new CA, you are ready for generating your own signed certs. The basic flow is the following:</p>

<ol>
  <li>Generate a private RSA key for your service/domain</li>
  <li>Create a CSR (Certificate Signing Request) using the key</li>
  <li>Use the CA to take the CSR and generate a signed CRT (Certificate)</li>
</ol>

<p>To help the process, I use the following script.</p>

<blockquote>
  <p>generate_certificate.sh</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-ne</span> 1 <span class="o">]</span>
<span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Usage: Must supply a domain"</span>
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">DOMAIN</span><span class="o">=</span><span class="nv">$1</span>

<span class="nb">cd</span> ~/certs

openssl genrsa <span class="nt">-out</span> <span class="nv">$DOMAIN</span>.key 2048
openssl req <span class="nt">-new</span> <span class="nt">-key</span> <span class="nv">$DOMAIN</span>.key <span class="nt">-out</span> <span class="nv">$DOMAIN</span>.csr

<span class="nb">cat</span> <span class="o">&gt;</span> <span class="nv">$DOMAIN</span>.ext <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names
[alt_names]
DNS.1 = </span><span class="nv">$DOMAIN</span><span class="sh">
</span><span class="no">EOF

</span>openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> <span class="nv">$DOMAIN</span>.csr <span class="nt">-CA</span> ~/certs/homeCA.pem <span class="nt">-CAkey</span> ~/certs/homeCA.key <span class="nt">-CAcreateserial</span> <span class="nt">-out</span> <span class="nv">$DOMAIN</span>.crt <span class="nt">-days</span> 825 <span class="nt">-sha256</span> <span class="nt">-extfile</span> <span class="nv">$DOMAIN</span>.ext
</code></pre></div></div>

<h3 id="docker-registry">Docker Registry</h3>

<p>Once you build your OpenFaaS functions, they get packaged and uploaded to a Docker Registry. You might want to simplify the setup and avoid a secure site using HTTPS but then your OpenFaaS server will fail to pull any deployed functions as it requires the registry be secured. So we need to not only create a local registry but also secure the traffic properly.</p>

<p>The easiest method for me was to compose a docker container that allows me to spin up my own registry that imports my CA certificates as well as the certificate files for the docker registry.</p>

<p>The steps to perform are:</p>

<ul>
  <li>Configure hostname to IP lookup</li>
  <li>Create the directory structure to house the files</li>
  <li>Generate the htpasswd file containing the details to sign into the registry</li>
  <li>Generate signed certificates for the registry using the CA</li>
  <li>Create the docker-compose.yml file</li>
  <li>Initialize and start the docker container</li>
</ul>

<h3 id="configure-hostname">Configure Hostname</h3>

<p>You might decide to host your docker registry directly on your local dev workstation or maybe you have a dedicated system you want to use. And you might end up moving your registry from one machine to another. For that reason I am using a different hostname for the docker registry. In this example it is <code class="language-plaintext highlighter-rouge">docker-registry.home.lan</code> but feel free to name this as you choose.</p>

<p>You can then create a static hostname lookup on your router to specify the IP the hostname will resolve to or you can update the <code class="language-plaintext highlighter-rouge">hosts</code> file relevant to the system you are using to redirect requests. The latter approach is a bit of a pain as this requires more work to update your workstation and the server hosting OpenFaaS should your docker-registry IP change.</p>

<h4 id="directory-structure">Directory Structure</h4>

<p>I created the following directory that will look like this after I have completed all the steps.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Local Registry
├── docker-compose.yml
├── auth
│   └── registry.password
├── ca-certs
│   └── homeCA.pem
├── certs
│   ├── docker-registry.home.lan.crt
│   └── docker-registry.home.lan.key
└── data
</code></pre></div></div>

<h4 id="registry-password">Registry Password</h4>

<p>The registry password uses the same format and encoding created using the <a href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html">htpasswd</a> command. You can either install this on you local WSL (Windows Subsystem for Linux) or spin up a simple httpd container to gain access to the command.</p>

<p>To create the passwd is simple:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>htpasswd <span class="nt">-Bbn</span> testuser testpassword
</code></pre></div></div>

<p>This results in the following output, which you can copy and paste into the <code class="language-plaintext highlighter-rouge">registry.password</code> file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testuser:$2y$05$hMczGGIYEh6WrHs.Dbg79.pB57GRHeKlyBLNTenrnXbw4z2Z5u4ui
</code></pre></div></div>

<h4 id="certificates">Certificates</h4>

<p>Next use the script mentioned above to generate both the private and signed certificate files and place them into the <code class="language-plaintext highlighter-rouge">certs</code> folder. Then in the <code class="language-plaintext highlighter-rouge">ca-certs</code> folder you will place a copy of the <code class="language-plaintext highlighter-rouge">homeCA.pem</code> you created in the beginning.</p>

<h4 id="docker-compose-file">Docker Compose file</h4>

<p>Now all that is left is to create the yaml file for composing the container using the default <code class="language-plaintext highlighter-rouge">docker-registry</code> image. The local volume mounting points will vary based on where your project is located and if your running on a mac/linux or not using WSL2 integration on a windows machine.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">docker-registry</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">registry:2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">docker-registry</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">5000:5000</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>    
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/mnt/e/Workspace/Docker/Local Registry/data:/var/lib/registry</span>
      <span class="pi">-</span> <span class="s">/mnt/e/Workspace/Docker/Local Registry/ca-certs:/usr/local/share/ca-certificates</span>
      <span class="pi">-</span> <span class="s">/mnt/e/Workspace/Docker/Local Registry/certs:/certs</span>
      <span class="pi">-</span> <span class="s">/mnt/e/Workspace/Docker/Local Registry/auth:/auth</span>
    <span class="na">environment</span><span class="pi">:</span> 
      <span class="na">ServerName</span><span class="pi">:</span> <span class="s">docker-registry.home.lan</span>
      <span class="na">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="pi">:</span> <span class="s">/certs/docker-registry.home.lan.crt</span>
      <span class="na">REGISTRY_HTTP_TLS_KEY</span><span class="pi">:</span> <span class="s">/certs/docker-registry.home.lan.key</span>
      <span class="na">REGISTRY_AUTH</span><span class="pi">:</span> <span class="s">htpasswd</span>
      <span class="na">REGISTRY_AUTH_HTPASSWD_REALM</span><span class="pi">:</span> <span class="s">Registry Realm</span>
      <span class="na">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="pi">:</span> <span class="s">/auth/registry.password</span>

  <span class="na">docker-registry-ui</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">konradkleine/docker-registry-frontend:v2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">docker-registry-ui</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8080:80</span>
    <span class="na">environment</span><span class="pi">:</span> 
      <span class="na">ServerName</span><span class="pi">:</span> <span class="s">docker-registry.home.lan</span>
      <span class="na">ENV_DOCKER_REGISTRY_HOST</span><span class="pi">:</span> <span class="s">docker-registry</span>
      <span class="na">ENV_DOCKER_REGISTRY_PORT</span><span class="pi">:</span> <span class="m">5000</span>
</code></pre></div></div>

<h4 id="run-it">Run it</h4>

<p>Now all that is left is to start up your container and hopefully everything works without an issue. Open a command prompt/shell and navigate to the directory where your <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> is located.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up
</code></pre></div></div>

<p>You can now login to your local repository using the credentials you specified for the htpasswd file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login docker-registry.home.lan:5000
</code></pre></div></div>

<h3 id="openfaas-buildkit">OpenFaaS BuildKit</h3>

<p><strong>Update 2021-02-20</strong>: <a href="/2021/02/20/my-web-app-journey-buildkit-control/">I refined the process for setting up the buildkit</a></p>

<p>So you have your OpenFaaS server running and while you were able to deploy the sample function that was already pre-compiled to target the Arm 64 architecture, chances are that you are using a x86 platform to write and build your functions on. For this reason you will end up relying on a BuildKit that will help build images that target the ARM architecture. The downside is the buildkit does not trust your CA so will fail to deploy to your docker registry.</p>

<p>The solution I found was to attempt the build process and fail. Once the buildkit container is provisioned, start it and copy my CA over to it. Restart the buildkit and it should now trust our private CA and thus will not fail during the build process.</p>

<p>As mentioned above I navigated to the folder where I had created my OpenFaas functions (on my workstation) and triggered the publish.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>faas-cli publish -f node-functions.yml --platforms linux/arm64,linux/arm/7 --no-cache
</code></pre></div></div>

<p>This goes through the build motions which first requires creating a docker container for the build kit that targets multiple architectures. Once it has finished building the images, it will try to deploy to your</p>

<p>You will first need to get the Container ID for the build kit in order to copy your CA from a folder on your host machine (in this case my workstation).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker container ls -a
</code></pre></div></div>

<p>This will give you a list of containers (example below) where you will find the Container ID that has the names of <code class="language-plaintext highlighter-rouge">buildx_buildkit_multiarch</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID   IMAGE                                      COMMAND                  CREATED       STATUS                      PORTS                           NAMES
11740c0f2585   moby/buildkit:buildx-stable-1              "buildkitd"              6 weeks ago   Exited (1) 51 seconds ago                                   buildx_buildkit_multiarch
ed3c9250c2dd   registry:2                                 "/entrypoint.sh /etc…"   7 weeks ago   Up 6 minutes                0.0.0.0:5000-&gt;5000/tcp          docker-registry
fc8e664eb511   konradkleine/docker-registry-frontend:v2   "/bin/sh -c $START_S…"   7 weeks ago   Exited (255) 5 hours ago    443/tcp, 0.0.0.0:8080-&gt;80/tcp   docker-registry-ui
</code></pre></div></div>

<p>Now copy your <code class="language-plaintext highlighter-rouge">homeCA.crt</code> certificate file directly into the volume of the build kit like so and force the container to update the certificates. You might also need to restart the build kit container if it fails.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker cp homeCA.crt 11740c0f2585:/usr/local/share/ca-certificates
docker exec 11740c0f2585 update-ca-certificates
docker restart 11740c0f2585
</code></pre></div></div>

<p>Now you should be able to publish your functions and then deploy it your OpenFaaS server.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>faas-cli publish -f node-functions.yml --platforms linux/arm64,linux/arm/7 --no-cache
faas-cli deploy -f node-functions.yml
</code></pre></div></div>

<p>Hopefully everything went as planned and you can then test your function either using the <code class="language-plaintext highlighter-rouge">faas-cli</code> or through the dashboard.</p>

<h3 id="contributing-research-material">Contributing Research Material</h3>

<p><a href="https://alexellisuk.medium.com/walk-through-install-kubernetes-to-your-raspberry-pi-in-15-minutes-84a8492dc95a">Alex Ellis OpenFaaS in 15 minutes</a></p>

<p><a href="https://deliciousbrains.com/ssl-certificate-authority-for-local-https-development/">How to Create Your Own SSL Certificate Authority for Local HTTPS Development</a></p>

<p><a href="https://gabrieltanner.org/blog/docker-registry">How to create your own private Docker registry and secure it</a></p>

<p><a href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html">htpasswd - Manage user files for basic authentication</a></p>


  </div><a class="u-url" href="/2021/02/07/my-web-app-journey-mind-the-gap/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">My Perspective of the world</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">My Perspective of the world</li><li><a class="u-email" href="mailto:xiltch@gmail.com">xiltch@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/xiltch"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">xiltch</span></a></li><li><a href="https://www.twitter.com/xiltch"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">xiltch</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>The chronicles of a geek, author of code and connoisseur of fine electronics.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
